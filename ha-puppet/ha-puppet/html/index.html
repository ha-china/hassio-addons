<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Puppet - Screenshot Preview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        --ha-blue: #03a9f4;
        --ha-blue-dark: #0288d1;
        --ha-blue-light: #4fc3f7;
      }
      body {
        background: linear-gradient(135deg, #03a9f4 0%, #0288d1 100%);
        min-height: 100vh;
      }
      .preview-container {
        max-width: 100%;
        overflow: auto;
      }
      .preview-img {
        max-width: 100%;
        height: auto;
        border: 2px solid var(--ha-blue);
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }
      .loading {
        opacity: 0.5;
        pointer-events: none;
      }
    </style>
  </head>
  <body class="p-4">
    <div class="container mx-auto max-w-7xl">
      <!-- Main Content -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Form Section -->
        <div class="lg:col-span-1 bg-white rounded-lg shadow-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <h2
              class="text-xl font-semibold"
              style="color: var(--ha-blue-dark)"
            >
              Screenshot Settings
            </h2>
            <button
              onclick="showImportDialog()"
              class="p-2 rounded-md transition duration-200 hover:bg-gray-100"
              title="Import screenshot URL"
              style="color: var(--ha-blue)"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"
                />
              </svg>
            </button>
          </div>

          <form id="screenshotForm" class="space-y-4">
            <!-- Device Selector -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Device (optional)</label
              >
              <select
                id="device"
                class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:border-transparent"
                style="
                  border-color: var(--ha-blue-light);
                  --tw-ring-color: var(--ha-blue);
                "
              >
                <option value="">Custom / Manual Configuration</option>
              </select>
              <p class="text-xs text-gray-500 mt-1">
                Select a predefined device to automatically apply viewport, colors, and dithering settings. The generated URL will include the device parameter plus any manual overrides.
              </p>
            </div>

            <!-- Path -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Path</label
              >
              <input
                type="text"
                id="path"
                value="/lovelace"
                class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:border-transparent"
                style="
                  border-color: var(--ha-blue-light);
                  --tw-ring-color: var(--ha-blue);
                "
                placeholder="/lovelace"
              />
            </div>

            <!-- Viewport Width -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Viewport Width</label
              >
              <input
                type="number"
                id="width"
                value="1000"
                min="100"
                max="4000"
                class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:border-transparent"
                style="
                  border-color: var(--ha-blue-light);
                  --tw-ring-color: var(--ha-blue);
                "
              />
            </div>

            <!-- Viewport Height -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Viewport Height</label
              >
              <input
                type="number"
                id="height"
                value="1000"
                min="100"
                max="4000"
                class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:border-transparent"
                style="
                  border-color: var(--ha-blue-light);
                  --tw-ring-color: var(--ha-blue);
                "
              />
            </div>

            <!-- Next -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Auto-refresh Interval (seconds, optional)</label
              >
              <input
                type="number"
                id="next"
                min="1"
                class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:border-transparent"
                style="
                  border-color: var(--ha-blue-light);
                  --tw-ring-color: var(--ha-blue);
                "
                placeholder="e.g., 300, 600"
              />
              <p class="text-xs text-gray-500 mt-1">
                The server will warm up the browser just before your code
                fetches the next screenshot, speeding up the response time.
              </p>
            </div>

            <!-- Theme -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Theme (optional)</label
              >
              <select
                id="theme"
                class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:border-transparent"
                style="
                  border-color: var(--ha-blue-light);
                  --tw-ring-color: var(--ha-blue);
                "
              >
                <option value="">Default</option>
              </select>
              <p class="text-xs text-gray-500 mt-1">
                Find more themes at the
                <a
                  href="https://community.home-assistant.io/c/projects/themes/29"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="underline hover:text-gray-700"
                  style="color: var(--ha-blue)"
                  >Home Assistant Community</a
                >
              </p>
            </div>

            <!-- Dark Mode -->
            <div class="flex items-center">
              <input
                type="checkbox"
                id="dark"
                class="h-4 w-4 border-gray-300 rounded"
                style="color: var(--ha-blue); --tw-ring-color: var(--ha-blue)"
              />
              <label for="dark" class="ml-2 block text-sm text-gray-700"
                >Dark Mode</label
              >
            </div>

            <!-- Zoom -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Zoom (optional)</label
              >
              <input
                type="number"
                id="zoom"
                step="0.1"
                min="0.1"
                max="5"
                class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:border-transparent"
                style="
                  border-color: var(--ha-blue-light);
                  --tw-ring-color: var(--ha-blue);
                "
                placeholder="1.0"
              />
            </div>

            <!-- Language -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Language (optional)</label
              >
              <input
                type="text"
                id="lang"
                class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:border-transparent"
                style="
                  border-color: var(--ha-blue-light);
                  --tw-ring-color: var(--ha-blue);
                "
                placeholder="e.g., en, nl, de"
              />
            </div>

            <!-- Advanced Settings Accordion -->
            <div class="border-t pt-4">
              <button
                type="button"
                id="advancedToggle"
                class="w-full flex items-center justify-between text-sm font-medium text-gray-700 hover:text-gray-900"
                onclick="toggleAdvanced()"
              >
                <span>Advanced Settings</span>
                <svg
                  id="advancedIcon"
                  class="w-5 h-5 transition-transform"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
              </button>

              <div id="advancedSettings" class="hidden mt-4 space-y-4">
                <!-- Format -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1"
                    >Format</label
                  >
                  <select
                    id="format"
                    class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:border-transparent"
                    style="
                      border-color: var(--ha-blue-light);
                      --tw-ring-color: var(--ha-blue);
                    "
                  >
                    <option value="png">PNG</option>
                    <option value="jpeg">JPEG</option>
                    <option value="webp">WebP</option>
                    <option value="bmp">BMP</option>
                  </select>
                </div>

                <!-- Wait Time -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1"
                    >Wait Time (ms)</label
                  >
                  <input
                    type="number"
                    id="wait"
                    step="100"
                    min="0"
                    class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:border-transparent"
                    style="
                      border-color: var(--ha-blue-light);
                      --tw-ring-color: var(--ha-blue);
                    "
                    placeholder="0"
                  />
                  <p class="text-xs text-gray-500 mt-1">
                    Add extra wait time before capturing the screenshot. Useful
                    if you have animations or lazy-loaded content.
                  </p>
                </div>

                <!-- Custom Color Palette -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1"
                    >Custom Color Palette (Output)</label
                  >
                  <input
                    type="text"
                    id="colors"
                    class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:border-transparent font-mono text-sm"
                    style="
                      border-color: var(--ha-blue-light);
                      --tw-ring-color: var(--ha-blue);
                    "
                    placeholder="e.g., FF0000,00FF00,0000FF"
                  />
                  <p class="text-xs text-gray-500 mt-1">
                    Output colors: comma-separated hex values (with or without #).
                  </p>
                </div>

                <!-- Palette Colors (Quantization) -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1"
                    >Palette Colors (Quantization)</label
                  >
                  <input
                    type="text"
                    id="palette_colors"
                    class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:border-transparent font-mono text-sm"
                    style="
                      border-color: var(--ha-blue-light);
                      --tw-ring-color: var(--ha-blue);
                    "
                    placeholder="e.g., 000000,808080,FFFFFF"
                  />
                  <p class="text-xs text-gray-500 mt-1">
                    Colors for matching pixels (e.g., grayscale values). Must match the count of Output colors. Matched colors are then mapped to Output colors in order.
                  </p>
                </div>

                <!-- Dithering Algorithm -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1"
                    >Dithering Algorithm</label
                  >
                  <select
                    id="dithering"
                    class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:border-transparent"
                    style="
                      border-color: var(--ha-blue-light);
                      --tw-ring-color: var(--ha-blue);
                    "
                  >
                    <option value="none">None</option>
                    <option value="floyd-steinberg">Floyd-Steinberg (Classic)</option>
                    <option value="atkinson">Atkinson (Soft)</option>
                    <option value="jarvis-judice-ninke">Jarvis-Judice-Ninke (High Quality)</option>
                    <option value="stucki">Stucki (Detailed)</option>
                    <option value="burkes">Burkes (Fast)</option>
                    <option value="sierra">Sierra (Smooth)</option>
                    <option value="sierra-lite">Sierra Lite (Simple)</option>
                  </select>
                  <p class="text-xs text-gray-500 mt-1">
                    Apply dithering when reducing colors (e.g., for e-ink displays). Different algorithms offer trade-offs between speed, quality, and visual style.
                  </p>
                </div>

                <!-- Rotation -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1"
                    >Rotation</label
                  >
                  <select
                    id="rotate"
                    class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:border-transparent"
                    style="
                      border-color: var(--ha-blue-light);
                      --tw-ring-color: var(--ha-blue);
                    "
                  >
                    <option value="">None</option>
                    <option value="90">90°</option>
                    <option value="180">180°</option>
                    <option value="270">270°</option>
                  </select>
                </div>

                <!-- Invert -->
                <div class="flex items-center">
                  <input
                    type="checkbox"
                    id="invert"
                    class="h-4 w-4 border-gray-300 rounded"
                    style="
                      color: var(--ha-blue);
                      --tw-ring-color: var(--ha-blue);
                    "
                  />
                  <label for="invert" class="ml-2 block text-sm text-gray-700"
                    >Invert Colors</label
                  >
                </div>
              </div>
            </div>

            <!-- Hidden submit button to enable Enter key submission -->
            <button type="submit" class="hidden">Submit</button>
          </form>
        </div>

        <!-- Preview Section -->
        <div class="lg:col-span-2 bg-white rounded-lg shadow-lg p-6">
          <div class="flex justify-between items-center mb-4">
            <h2
              class="text-xl font-semibold"
              style="color: var(--ha-blue-dark)"
            >
              Preview
            </h2>
            <div id="loadTime" class="text-sm text-gray-600 hidden">
              <span class="font-semibold">Load time:</span>
              <span id="loadTimeValue"></span>
            </div>
          </div>

          <!-- Generated URL -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Generated URL</label
            >
            <div class="flex gap-2">
              <input
                type="text"
                id="generatedUrl"
                readonly
                class="flex-1 px-3 py-2 bg-gray-50 border border-gray-300 rounded-md text-sm font-mono"
                value=""
              />
              <button
                onclick="loadPreview(event)"
                class="px-4 py-2 text-white rounded-md transition duration-200 shadow-md"
                style="background-color: var(--ha-blue)"
                onmouseover="this.style.backgroundColor='var(--ha-blue-dark)'"
                onmouseout="this.style.backgroundColor='var(--ha-blue)'"
              >
                Preview
              </button>
              <button
                onclick="copyUrl()"
                class="px-4 py-2 text-white rounded-md transition duration-200"
                style="background-color: #10b981"
                onmouseover="this.style.backgroundColor='#059669'"
                onmouseout="this.style.backgroundColor='#10b981'"
              >
                Copy
              </button>
            </div>
            <p
              id="copyFeedback"
              class="text-sm mt-1 hidden"
              style="color: #10b981"
            >
              URL copied to clipboard!
            </p>
          </div>

          <div id="loadingIndicator" class="hidden text-center py-12">
            <div
              class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-t-transparent"
              style="
                border-color: var(--ha-blue);
                border-top-color: transparent;
              "
            ></div>
            <p class="mt-4 text-gray-600">Generating screenshot...</p>
          </div>

          <div
            id="errorMessage"
            class="hidden bg-red-50 border border-red-300 text-red-700 px-4 py-3 rounded-md mb-4"
          >
            <p class="font-semibold">Error</p>
            <p id="errorText"></p>
          </div>

          <div class="preview-container" id="previewContainer">
            <img
              id="previewImage"
              src=""
              alt="Screenshot preview will appear here"
              class="preview-img hidden"
            />
            <div id="placeholderText" class="text-center py-24 text-gray-400">
              <svg
                class="mx-auto h-24 w-24 mb-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                />
              </svg>
              <p class="text-lg">
                Click "Preview Screenshot" to generate an image
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="mt-6 text-center">
        <a
          href="https://github.com/balloob/home-assistant-addons/blob/main/puppet/README.md"
          target="_blank"
          rel="noopener noreferrer"
          class="text-white font-bold hover:underline opacity-80 hover:opacity-100 transition-opacity"
          >Puppet by Balloob</a
        >
      </div>
    </div>

    <!-- Import URL Dialog -->
    <div
      id="importDialog"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
    >
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold" style="color: var(--ha-blue-dark)">
            Import Screenshot URL
          </h3>
          <button
            onclick="hideImportDialog()"
            class="text-gray-400 hover:text-gray-600"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <p class="text-sm text-gray-600 mb-4">
          Paste a screenshot URL to load its settings into the form.
        </p>

        <input
          type="text"
          id="importUrlInput"
          placeholder="e.g., http://192.168.1.30:10000/lovelace/0?viewport=1000x600&theme=midnight"
          class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:border-transparent font-mono text-sm mb-2"
          style="
            border-color: var(--ha-blue-light);
            --tw-ring-color: var(--ha-blue);
          "
          onkeypress="if(event.key === 'Enter') { event.preventDefault(); importUrl(); }"
        />

        <p
          id="importFeedback"
          class="text-sm mt-2 hidden"
          style="color: #10b981"
        ></p>
        <p id="importError" class="text-sm mt-2 hidden text-red-600"></p>

        <div class="flex justify-end gap-2 mt-6">
          <button
            onclick="hideImportDialog()"
            class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition duration-200"
          >
            Cancel
          </button>
          <button
            onclick="importUrl()"
            class="px-4 py-2 text-white rounded-md transition duration-200"
            style="background-color: var(--ha-blue)"
            onmouseover="this.style.backgroundColor='var(--ha-blue-dark)'"
            onmouseout="this.style.backgroundColor='var(--ha-blue)'"
          >
            Import
          </button>
        </div>
      </div>
    </div>

    <script>
      // Save settings to localStorage
      function saveSettings() {
        const settings = {
          device: document.getElementById("device").value,
          path: document.getElementById("path").value,
          width: document.getElementById("width").value,
          height: document.getElementById("height").value,
          format: document.getElementById("format").value,
          theme: document.getElementById("theme").value,
          dark: document.getElementById("dark").checked,
          zoom: document.getElementById("zoom").value,
          wait: document.getElementById("wait").value,
          lang: document.getElementById("lang").value,
          colors: document.getElementById("colors").value,
          palette_colors: document.getElementById("palette_colors").value,
          dithering: document.getElementById("dithering").value,
          rotate: document.getElementById("rotate").value,
          invert: document.getElementById("invert").checked,
          next: document.getElementById("next").value,
        };
        localStorage.setItem("puppetSettings", JSON.stringify(settings));
      }

      // Load settings from localStorage
      function loadSettings() {
        const saved = localStorage.getItem("puppetSettings");
        if (!saved) return;

        try {
          const settings = JSON.parse(saved);

          if (settings.device !== undefined)
            document.getElementById("device").value = settings.device;
          if (settings.path !== undefined)
            document.getElementById("path").value = settings.path;
          if (settings.width !== undefined)
            document.getElementById("width").value = settings.width;
          if (settings.height !== undefined)
            document.getElementById("height").value = settings.height;
          if (settings.format !== undefined)
            document.getElementById("format").value = settings.format;
          if (settings.theme !== undefined)
            document.getElementById("theme").value = settings.theme;
          if (settings.dark !== undefined)
            document.getElementById("dark").checked = settings.dark;
          if (settings.zoom !== undefined)
            document.getElementById("zoom").value = settings.zoom;
          if (settings.wait !== undefined)
            document.getElementById("wait").value = settings.wait;
          if (settings.lang !== undefined)
            document.getElementById("lang").value = settings.lang;
          if (settings.colors !== undefined)
            document.getElementById("colors").value = settings.colors;
          if (settings.palette_colors !== undefined)
            document.getElementById("palette_colors").value = settings.palette_colors;
          if (settings.dithering !== undefined)
            document.getElementById("dithering").value = settings.dithering;
          if (settings.rotate !== undefined)
            document.getElementById("rotate").value = settings.rotate;
          if (settings.invert !== undefined)
            document.getElementById("invert").checked = settings.invert;
          if (settings.next !== undefined)
            document.getElementById("next").value = settings.next;
        } catch (e) {
          console.error("Error loading settings:", e);
        }
      }

      // Load settings from URL parameters
      function loadFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);

        // Extract device from query parameter
        if (urlParams.has("device")) {
          document.getElementById("device").value = urlParams.get("device");
        }

        // Extract path from query parameter
        if (urlParams.has("path")) {
          document.getElementById("path").value = urlParams.get("path");
        }

        // Parse viewport (widthxheight)
        const viewport = urlParams.get("viewport");
        if (viewport) {
          const [width, height] = viewport.split("x");
          if (width) document.getElementById("width").value = width;
          if (height) document.getElementById("height").value = height;
        }

        // Load other parameters
        if (urlParams.has("format")) {
          document.getElementById("format").value = urlParams.get("format");
        }
        if (urlParams.has("theme")) {
          document.getElementById("theme").value = urlParams.get("theme");
        }
        if (urlParams.has("dark")) {
          document.getElementById("dark").checked = true;
        }
        if (urlParams.has("zoom")) {
          document.getElementById("zoom").value = urlParams.get("zoom");
        }
        if (urlParams.has("wait")) {
          document.getElementById("wait").value = urlParams.get("wait");
        }
        if (urlParams.has("lang")) {
          document.getElementById("lang").value = urlParams.get("lang");
        }
        if (urlParams.has("colors")) {
          document.getElementById("colors").value = urlParams.get("colors");
        }
        if (urlParams.has("palette_colors")) {
          document.getElementById("palette_colors").value = urlParams.get("palette_colors");
        }
        if (urlParams.has("dithering")) {
          document.getElementById("dithering").value = urlParams.get("dithering");
        }
        if (urlParams.has("rotate")) {
          document.getElementById("rotate").value = urlParams.get("rotate");
        }
        if (urlParams.has("invert")) {
          document.getElementById("invert").checked = true;
        }
        if (urlParams.has("next")) {
          document.getElementById("next").value = urlParams.get("next");
        }
      }

      // Update browser URL to match current form settings
      function updateBrowserUrl() {
        const device = document.getElementById("device").value;
        const path = document.getElementById("path").value || "/";
        const width = document.getElementById("width").value;
        const height = document.getElementById("height").value;
        const format = document.getElementById("format").value;
        const theme = document.getElementById("theme").value;
        const dark = document.getElementById("dark").checked;
        const zoom = document.getElementById("zoom").value;
        const wait = document.getElementById("wait").value;
        const lang = document.getElementById("lang").value;
        const colors = document.getElementById("colors").value;
        const palette_colors = document.getElementById("palette_colors").value;
        const dithering = document.getElementById("dithering").value;
        const rotate = document.getElementById("rotate").value;
        const invert = document.getElementById("invert").checked;
        const next = document.getElementById("next").value;

        // Build query parameters - include path as a query param
        const params = new URLSearchParams();
        params.append("path", path);
        params.append("viewport", `${width}x${height}`);

        if (device) {
          params.append("device", device);
        }
        if (format && format !== "png") {
          params.append("format", format);
        }
        if (theme) {
          params.append("theme", theme);
        }
        if (dark) {
          params.append("dark", "");
        }
        if (zoom) {
          params.append("zoom", zoom);
        }
        if (wait) {
          params.append("wait", wait);
        }
        if (lang) {
          params.append("lang", lang);
        }
        if (colors) {
          params.append("colors", colors);
        }
        if (palette_colors) {
          params.append("palette_colors", palette_colors);
        }
        if (dithering && dithering !== "none") {
          params.append("dithering", dithering);
        }
        if (rotate) {
          params.append("rotate", rotate);
        }
        if (invert) {
          params.append("invert", "");
        }
        if (next) {
          params.append("next", next);
        }

        // Keep UI at root path, all settings in query string
        const newUrl = `${window.location.origin}/?${params.toString()}`;

        // Update browser URL without reloading the page
        window.history.replaceState({}, "", newUrl);
      }

      // Import URL Dialog Functions
      function showImportDialog() {
        const dialog = document.getElementById("importDialog");
        const input = document.getElementById("importUrlInput");
        const feedback = document.getElementById("importFeedback");
        const error = document.getElementById("importError");

        // Clear previous state
        input.value = "";
        feedback.classList.add("hidden");
        error.classList.add("hidden");

        // Show dialog
        dialog.classList.remove("hidden");

        // Focus input
        setTimeout(() => input.focus(), 100);

        // Add ESC key listener
        document.addEventListener("keydown", handleDialogEscape);
      }

      function hideImportDialog() {
        const dialog = document.getElementById("importDialog");
        dialog.classList.add("hidden");

        // Remove ESC key listener
        document.removeEventListener("keydown", handleDialogEscape);
      }

      function handleDialogEscape(e) {
        if (e.key === "Escape") {
          hideImportDialog();
        }
      }

      function importUrl() {
        const input = document.getElementById("importUrlInput");
        const feedback = document.getElementById("importFeedback");
        const error = document.getElementById("importError");
        const urlString = input.value.trim();

        // Hide previous messages
        feedback.classList.add("hidden");
        error.classList.add("hidden");

        if (!urlString) {
          error.textContent = "Please enter a URL";
          error.classList.remove("hidden");
          return;
        }

        try {
          // Parse the URL - handle both full URLs and relative paths
          let url;
          if (
            urlString.startsWith("http://") ||
            urlString.startsWith("https://")
          ) {
            url = new URL(urlString);
          } else {
            // Relative path, add dummy origin
            url = new URL(urlString, "http://dummy");
          }

          const urlParams = url.searchParams;
          const pathname = url.pathname;

          // Extract device parameter
          if (urlParams.has("device")) {
            document.getElementById("device").value = urlParams.get("device");
          }

          // Extract path from pathname if it's not just "/"
          if (pathname && pathname !== "/") {
            document.getElementById("path").value = pathname;
          }

          // Parse viewport (widthxheight)
          const viewport = urlParams.get("viewport");
          if (viewport) {
            const [width, height] = viewport.split("x");
            if (width) document.getElementById("width").value = width;
            if (height) document.getElementById("height").value = height;
          }

          // Load other parameters
          if (urlParams.has("format")) {
            document.getElementById("format").value = urlParams.get("format");
          }
          if (urlParams.has("theme")) {
            document.getElementById("theme").value = urlParams.get("theme");
          }
          if (urlParams.has("dark")) {
            document.getElementById("dark").checked = true;
          } else {
            document.getElementById("dark").checked = false;
          }
          if (urlParams.has("zoom")) {
            document.getElementById("zoom").value = urlParams.get("zoom");
          }
          if (urlParams.has("wait")) {
            document.getElementById("wait").value = urlParams.get("wait");
          }
          if (urlParams.has("lang")) {
            document.getElementById("lang").value = urlParams.get("lang");
          }

          // Handle deprecated eink parameter - convert to colors
          if (urlParams.has("eink") && !urlParams.has("colors")) {
            const einkValue = parseInt(urlParams.get("eink"));
            if (einkValue === 2) {
              // Convert eink=2 to black and white colors
              document.getElementById("colors").value = "000000,FFFFFF";
              console.log('[eink migration] Imported URL with eink=2, converted to colors=000000,FFFFFF');
              feedback.textContent = "⚠ Imported URL contained deprecated 'eink' parameter. Automatically converted to 'colors' parameter.";
              feedback.classList.remove("hidden");
            }
          } else if (urlParams.has("colors")) {
            document.getElementById("colors").value = urlParams.get("colors");
          }

          if (urlParams.has("palette_colors")) {
            document.getElementById("palette_colors").value = urlParams.get("palette_colors");
          }
          if (urlParams.has("dithering")) {
            document.getElementById("dithering").value = urlParams.get("dithering");
          }
          if (urlParams.has("rotate")) {
            document.getElementById("rotate").value = urlParams.get("rotate");
          }
          if (urlParams.has("invert")) {
            document.getElementById("invert").checked = true;
          } else {
            document.getElementById("invert").checked = false;
          }
          if (urlParams.has("next")) {
            document.getElementById("next").value = urlParams.get("next");
          }

          // Update the UI
          updateUrl();
          updateBrowserUrl();
          saveSettings();

          // Close dialog and start preview immediately
          hideImportDialog();
          loadPreview();
        } catch (e) {
          console.error("Error importing URL:", e);
          error.textContent = "Invalid URL format. Please check and try again.";
          error.classList.remove("hidden");
        }
      }

      // Toggle advanced settings accordion
      function toggleAdvanced() {
        const advancedSettings = document.getElementById("advancedSettings");
        const advancedIcon = document.getElementById("advancedIcon");

        if (advancedSettings.classList.contains("hidden")) {
          advancedSettings.classList.remove("hidden");
          advancedIcon.style.transform = "rotate(180deg)";
        } else {
          advancedSettings.classList.add("hidden");
          advancedIcon.style.transform = "rotate(0deg)";
        }
      }

      // Build URL from form parameters
      function buildUrl() {
        const device = document.getElementById("device").value;
        const path = document.getElementById("path").value || "/";
        const width = document.getElementById("width").value;
        const height = document.getElementById("height").value;
        const format = document.getElementById("format").value;
        const theme = document.getElementById("theme").value;
        const dark = document.getElementById("dark").checked;
        const zoom = document.getElementById("zoom").value;
        const wait = document.getElementById("wait").value;
        const lang = document.getElementById("lang").value;
        const colors = document.getElementById("colors").value;
        const palette_colors = document.getElementById("palette_colors").value;
        const dithering = document.getElementById("dithering").value;
        const rotate = document.getElementById("rotate").value;
        const invert = document.getElementById("invert").checked;
        const next = document.getElementById("next").value;

        // Build query parameters
        const params = new URLSearchParams();

        // When a device is selected, include device parameter
        // Also include any manually overridden parameters
        if (device && currentDeviceConfig) {
          params.append("device", device);

          // Check for manual overrides by comparing with device config
          const currentViewport = `${width}x${height}`;
          const deviceViewport = `${currentDeviceConfig.width}x${currentDeviceConfig.height}`;
          if (currentViewport !== deviceViewport) {
            params.append("viewport", currentViewport);
          }

          if (colors && colors !== (currentDeviceConfig.colors || "")) {
            params.append("colors", colors);
          }

          if (palette_colors && palette_colors !== (currentDeviceConfig.palette_colors || "")) {
            params.append("palette_colors", palette_colors);
          }

          if (dithering && dithering !== (currentDeviceConfig.dithering || "none")) {
            params.append("dithering", dithering);
          }
        } else {
          // No device selected - include viewport and color parameters
          params.append("viewport", `${width}x${height}`);

          if (colors) {
            params.append("colors", colors);
          }

          if (palette_colors) {
            params.append("palette_colors", palette_colors);
          }

          if (dithering && dithering !== "none") {
            params.append("dithering", dithering);
          }
        }

        if (format && format !== "png") {
          params.append("format", format);
        }

        if (theme) {
          params.append("theme", theme);
        }

        if (dark) {
          params.append("dark", "");
        }

        if (zoom) {
          params.append("zoom", zoom);
        }

        if (wait) {
          params.append("wait", wait);
        }

        if (lang) {
          params.append("lang", lang);
        }

        if (rotate) {
          params.append("rotate", rotate);
        }

        if (invert) {
          params.append("invert", "");
        }

        if (next) {
          params.append("next", next);
        }

        // Construct full URL with port 10000
        let baseUrl;
        if (window.hass?.network?.internal) {
          try {
            const haUrl = new URL(window.hass.network.internal);
            haUrl.port = "10000";
            baseUrl = haUrl.origin;
          } catch (e) {
            baseUrl = window.location.origin;
          }
        } else {
          baseUrl = window.location.origin;
        }

        const fullPath = path.startsWith("/") ? path : "/" + path;
        const url = `${baseUrl}${fullPath}?${params.toString()}`;

        return url;
      }

      // Update the displayed URL
      function updateUrl() {
        const url = buildUrl();
        document.getElementById("generatedUrl").value = url;
      }

      // Copy URL to clipboard
      function copyUrl() {
        const urlInput = document.getElementById("generatedUrl");
        urlInput.select();
        document.execCommand("copy");

        const feedback = document.getElementById("copyFeedback");
        feedback.classList.remove("hidden");
        setTimeout(() => {
          feedback.classList.add("hidden");
        }, 2000);
      }

      // Load preview image
      async function loadPreview(e) {
        if (e) e.preventDefault();

        const fullUrl = buildUrl();
        const previewImage = document.getElementById("previewImage");
        const loadingIndicator = document.getElementById("loadingIndicator");
        const errorMessage = document.getElementById("errorMessage");
        const placeholderText = document.getElementById("placeholderText");
        const loadTimeDiv = document.getElementById("loadTime");
        const loadTimeValue = document.getElementById("loadTimeValue");

        // Hide load time while loading
        loadTimeDiv.classList.add("hidden");

        // Show loading state
        loadingIndicator.classList.remove("hidden");
        errorMessage.classList.add("hidden");
        previewImage.classList.add("hidden");
        placeholderText.classList.add("hidden");

        // Track start time
        const startTime = performance.now();

        try {
          // Use relative path to avoid CORS issues
          const url = new URL(fullUrl);
          const relativePath = url.pathname + url.search;

          // Fetch the screenshot
          const response = await fetch(relativePath);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          // Create blob URL for the image
          const blob = await response.blob();
          const imageUrl = URL.createObjectURL(blob);

          // Calculate load time
          const endTime = performance.now();
          const loadDuration = Math.round(endTime - startTime);

          // Display the image
          previewImage.src = imageUrl;
          previewImage.classList.remove("hidden");

          // Show load time
          loadTimeValue.textContent = `${loadDuration} ms`;
          loadTimeDiv.classList.remove("hidden");
        } catch (error) {
          console.error("Error loading preview:", error);
          document.getElementById("errorText").textContent = error.message;
          errorMessage.classList.remove("hidden");
          placeholderText.classList.remove("hidden");
        } finally {
          loadingIndicator.classList.add("hidden");
        }
      }

      // Populate device picker with available devices
      function populateDevicePicker() {
        const deviceSelect = document.getElementById("device");

        if (!window.devices?.devices) {
          console.log("No devices configuration found");
          return;
        }

        // Clear existing options except the first one (Custom)
        deviceSelect.innerHTML = '<option value="">Custom / Manual Configuration</option>';

        // Create a combined list of devices and aliases
        const deviceOptions = [];

        // Add all devices
        Object.keys(window.devices.devices).forEach((deviceId) => {
          const device = window.devices.devices[deviceId];
          deviceOptions.push({
            id: deviceId,
            name: device.name || deviceId,
            isAlias: false
          });
        });

        // Add all aliases
        if (window.devices.aliases) {
          Object.keys(window.devices.aliases).forEach((aliasId) => {
            const targetDevice = window.devices.aliases[aliasId];
            const device = window.devices.devices[targetDevice];
            if (device) {
              deviceOptions.push({
                id: aliasId,
                name: `${aliasId} (${device.name || targetDevice})`,
                isAlias: true
              });
            }
          });
        }

        // Sort by name
        deviceOptions.sort((a, b) => a.name.localeCompare(b.name));

        // Add device options
        deviceOptions.forEach((option) => {
          const optionElement = document.createElement("option");
          optionElement.value = option.id;
          optionElement.textContent = option.name;
          deviceSelect.appendChild(optionElement);
        });
      }

      // Store the current device config for comparison
      let currentDeviceConfig = null;

      // Initialize currentDeviceConfig based on selected device
      function initializeDeviceConfig() {
        const deviceId = document.getElementById("device").value;

        if (!deviceId || !window.devices?.devices) {
          currentDeviceConfig = null;
          return;
        }

        // Resolve alias to actual device
        let actualDeviceId = deviceId;
        if (window.devices.aliases && window.devices.aliases[deviceId]) {
          actualDeviceId = window.devices.aliases[deviceId];
        }

        const device = window.devices.devices[actualDeviceId];
        if (!device) {
          currentDeviceConfig = null;
          return;
        }

        // Store device config for URL building
        currentDeviceConfig = device;
      }

      // Handle device selection change
      function onDeviceChange() {
        const deviceId = document.getElementById("device").value;

        if (!deviceId || !window.devices?.devices) {
          currentDeviceConfig = null;
          return; // No device selected or no devices available
        }

        // Resolve alias to actual device
        let actualDeviceId = deviceId;
        if (window.devices.aliases && window.devices.aliases[deviceId]) {
          actualDeviceId = window.devices.aliases[deviceId];
        }

        const device = window.devices.devices[actualDeviceId];
        if (!device) {
          console.error(`Device not found: ${actualDeviceId}`);
          currentDeviceConfig = null;
          return;
        }

        // Store device config for URL building
        currentDeviceConfig = device;

        // Apply device configuration to form fields
        if (device.width !== undefined) {
          document.getElementById("width").value = device.width;
        }
        if (device.height !== undefined) {
          document.getElementById("height").value = device.height;
        }
        if (device.colors !== undefined) {
          document.getElementById("colors").value = device.colors;
        }
        if (device.palette_colors !== undefined) {
          document.getElementById("palette_colors").value = device.palette_colors;
        }
        if (device.dithering !== undefined) {
          document.getElementById("dithering").value = device.dithering;
        }

        // Update URL and save settings
        updateUrl();
        updateBrowserUrl();
        saveSettings();
      }

      // Populate theme picker with available themes
      function populateThemePicker() {
        const themeSelect = document.getElementById("theme");

        if (!window.hass?.themes?.themes) {
          // No themes found, update placeholder
          themeSelect.innerHTML =
            '<option value="">No themes available</option>';
          return;
        }

        // Clear existing options and add default
        themeSelect.innerHTML = '<option value="">Default</option>';

        // Add theme options
        Object.keys(window.hass.themes.themes)
          .sort()
          .forEach((theme) => {
            const option = document.createElement("option");
            option.value = theme;
            option.textContent = theme;
            themeSelect.appendChild(option);
          });
      }

      // Prefill language from server config
      function prefillLanguage() {
        const langInput = document.getElementById("lang");

        if (window.hass?.config?.language && !langInput.value) {
          langInput.value = window.hass.config.language;
          langInput.placeholder = window.hass.config.language;
        }
      }

      // Form submission handler (triggered by pressing Enter in any field)
      document
        .getElementById("screenshotForm")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          loadPreview(e);
        });

      // Update URL and save settings when any input changes
      document
        .querySelectorAll("#screenshotForm input, #screenshotForm select")
        .forEach((input) => {
          input.addEventListener("input", () => {
            updateUrl();
            updateBrowserUrl();
            saveSettings();
          });
          input.addEventListener("change", () => {
            updateUrl();
            updateBrowserUrl();
            saveSettings();
          });
        });

      // Auto-preview when any checkbox or dropdown changes
      document
        .querySelectorAll(
          "#screenshotForm input[type='checkbox'], #screenshotForm select",
        )
        .forEach((input) => {
          input.addEventListener("change", () => {
            loadPreview();
          });
        });

      // Add event listener for device selector specifically to handle device changes
      // Note: loadPreview() is called by the generic select change listener below
      document.getElementById("device").addEventListener("change", () => {
        onDeviceChange();
      });

      // Load settings and initialize on page load
      window.addEventListener("load", () => {
        // Populate pickers first so options are available when loading settings
        populateDevicePicker();
        populateThemePicker();

        // Load from URL first (highest priority), then localStorage
        loadFromUrl();
        // Only load from localStorage if URL params are not present
        if (!window.location.search) {
          loadSettings();
        }

        // Initialize device config for URL building after loading settings
        initializeDeviceConfig();

        prefillLanguage();
        updateUrl();
        updateBrowserUrl();
        loadPreview();
      });
    </script>
  </body>
</html>
